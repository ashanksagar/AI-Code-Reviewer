<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Code Reviewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
</head>

<body class="bg-gray-900 text-gray-100 font-sans min-h-screen flex flex-col items-center justify-start py-10 px-4">
  <h1 class="text-4xl font-bold mb-6 text-blue-400">AI Code Reviewer</h1>

  <div id="dropzone" class="w-full max-w-xl border-2 border-dashed border-blue-500 rounded-2xl p-10 text-center transition hover:bg-blue-900/20 cursor-pointer">
    <p class="text-lg mb-2">ðŸ“‚ Drag & drop your code file here</p>
    <p class="text-sm text-gray-400">or click to select from your device</p>
    <input type="file" id="fileInput" class="hidden" accept=".py,.js,.java,.cpp,.c,.txt" />
  </div>

  <div class="w-full max-w-xl bg-gray-800 p-6 rounded-2xl shadow-md mt-8">
    <h2 class="text-xl font-semibold mb-3 text-blue-400"> Paste Code Manually</h2>
    <textarea id="codeInput" rows="10" class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 text-gray-200 font-mono" placeholder="Paste your code here..."></textarea>
    <button id="analyzeText" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-lg transition">
      Analyze Pasted Code
    </button>
  </div>


  <div id="loading" class="hidden mt-8 text-blue-400 text-lg animate-pulse">
     Analyzing your code... Please wait.
  </div>

  <div id="output" class="hidden mt-10 w-full max-w-3xl bg-gray-800 p-6 rounded-2xl shadow-lg overflow-y-auto prose prose-invert max-h-[70vh]">
  </div>

  <div class="mt-16 w-full max-w-3xl bg-gray-800 p-6 rounded-2xl shadow-lg">
    <h2 class="text-2xl mb-4 text-blue-400 font-semibold"> Chat with AI Reviewer</h2>
    <div id="chat-box" class="bg-gray-900 p-4 rounded-lg h-80 overflow-y-auto mb-4"></div>
    <div class="flex gap-2">
      <input
        id="chat-input"
        type="text"
        placeholder="Ask about your code..."
        class="flex-1 bg-gray-700 text-gray-100 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-blue-500"
      />
      <button
        id="chat-send"
        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg"
      >Send</button>
    </div>
  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const output = document.getElementById('output');
    const loading = document.getElementById('loading');

    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('bg-blue-900/30');
    });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('bg-blue-900/30'));
    dropzone.addEventListener('drop', handleFile);
    fileInput.addEventListener('change', handleFile);

    async function handleFile(event) {
      event.preventDefault();
      dropzone.classList.remove('bg-blue-900/30');

      const file = event.dataTransfer ? event.dataTransfer.files[0] : fileInput.files[0];
      if (!file) return;

      output.classList.add('hidden');
      loading.classList.remove('hidden');

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch('/review', { method: 'POST', body: formData });
        const data = await res.json();

        loading.classList.add('hidden');
        output.classList.remove('hidden');

        let feedbackText = "No feedback found.";

        if (data.feedback) {

          if (typeof data.feedback === "object" && data.feedback.gpt_feedback) {
          feedbackText = data.feedback.gpt_feedback;
        } else if (typeof data.feedback === "string") {
          feedbackText = data.feedback;
        }
        } else if (data.analysis) {

          if (typeof data.analysis === "object" && data.analysis.gpt_feedback) {
            feedbackText = data.analysis.gpt_feedback;
          } else if (typeof data.analysis === "string") {
            feedbackText = data.analysis;
          }
        }

        const markdownHTML = marked.parse(feedbackText);
        output.innerHTML = markdownHTML;
        hljs.highlightAll();
      } catch (err) {
        loading.classList.add('hidden');
        output.classList.remove('hidden');
        output.innerHTML = `<p class="text-red-400">Error analyzing code: ${err.message}</p>`;
      }
    }

    document.getElementById("analyzeText").addEventListener("click", async () => {
      const code = document.getElementById("codeInput").value.trim();
      if (!code) {
        alert("Please paste some code before analyzing.");
        return;
      }

      output.classList.add("hidden");
      loading.classList.remove("hidden");

      const formData = new FormData();
      const blob = new Blob([code], { type: "text/plain" });
      formData.append("file", blob, "pasted_code.py");

      try {
        const res = await fetch("/review", { method: "POST", body: formData });
        const data = await res.json();

        loading.classList.add("hidden");
        output.classList.remove("hidden");

        let feedbackText = "No feedback found.";
        if (data.feedback?.gpt_feedback) feedbackText = data.feedback.gpt_feedback;
        else if (typeof data.feedback === "string") feedbackText = data.feedback;
        else if (data.analysis?.gpt_feedback) feedbackText = data.analysis.gpt_feedback;

        const markdownHTML = marked.parse(feedbackText);
        output.innerHTML = markdownHTML;
        hljs.highlightAll();
      } catch (err) {
        loading.classList.add("hidden");
        output.classList.remove("hidden");
        output.innerHTML = `<p class="text-red-400"> Error analyzing code: ${err.message}</p>`;
      }
    });

  </script>
  <script>
  const chatBox = document.getElementById('chat-box');
  const chatInput = document.getElementById('chat-input');
  const chatSend = document.getElementById('chat-send');

  chatSend.addEventListener('click', sendMessage);
  chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') sendMessage();
  });

  async function sendMessage() {
    const message = chatInput.value.trim();
    if (!message) return;

    appendMessage('You', message);
    chatInput.value = '';

    const formData = new FormData();
    formData.append('message', message);

    try {
      const res = await fetch('/chat', { method: 'POST', body: formData });
      const data = await res.json();
      appendMessage('AI', data.reply);
    } catch (err) {
      appendMessage('Error', err.message);
    }
  }

  function appendMessage(sender, text) {
    const msg = document.createElement('div');
    msg.classList.add('mb-2');
    msg.innerHTML = `<strong class="text-blue-400">${sender}:</strong> <span>${text}</span>`;
    chatBox.appendChild(msg);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
</script>

</body>
</html>
